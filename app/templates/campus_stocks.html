{% extends "base.html" %}
{% block title %}{{ campus.name }} Stock - IT Stock Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3><i class="bi bi-building"></i> {{ campus.name }} <span class="badge bg-secondary">{{ campus.code }}</span></h3>
        {% if campus.address %}<small class="text-muted"><i class="bi bi-geo-alt"></i> {{ campus.address }}</small>{% endif %}
    </div>
    <div>
        <a href="{{ url_for('stock.transfer_stock', campus_id=campus.id) }}" class="btn btn-info btn-sm">
            <i class="bi bi-arrow-left-right"></i> Transfer
        </a>
        <a href="{{ url_for('stock.download_pdf', campus_id=campus.id) }}" class="btn btn-danger btn-sm">
            <i class="bi bi-file-pdf"></i> PDF
        </a>
        <a href="{{ url_for('excel.download_campus_stock', campus_id=campus.id) }}" class="btn btn-success btn-sm">
            <i class="bi bi-download"></i> Excel
        </a>
        <a href="{{ url_for('stock.add_stock') }}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle"></i> Add Asset
        </a>
        <a href="{{ url_for('stock.dashboard') }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<!-- Filters -->
<div class="card mb-3">
    <div class="card-body py-2">
        <form method="GET" class="row g-2 align-items-end">
            <div class="col-md-3">
                <input type="text" name="search" class="form-control form-control-sm" placeholder="Search name / asset tag / serial..." value="{{ search }}">
            </div>
            <div class="col-md-2">
                <select name="category" class="form-select form-select-sm">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select name="status" class="form-select form-select-sm">
                    <option value="">All Statuses</option>
                    {% for s in ['Active','In Storage','Under Repair','Retired','Lost-Stolen','Disposed'] %}
                    <option value="{{ s }}" {% if status_filter == s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select name="assigned" class="form-select form-select-sm">
                    <option value="">All Assignment</option>
                    <option value="assigned" {% if assigned_filter == 'assigned' %}selected{% endif %}>Assigned</option>
                    <option value="unassigned" {% if assigned_filter == 'unassigned' %}selected{% endif %}>Unassigned</option>
                </select>
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-sm btn-primary w-100"><i class="bi bi-search"></i></button>
            </div>
            {% if search or category_filter or status_filter or assigned_filter %}
            <div class="col-md-1">
                <a href="{{ url_for('stock.campus_stocks', campus_id=campus.id) }}" class="btn btn-sm btn-outline-secondary w-100">Clear</a>
            </div>
            {% endif %}
        </form>
    </div>
</div>

<!-- Stock Table -->
{% if stocks %}
<div class="table-responsive">
    <table class="table table-striped table-hover table-bordered table-sm">
        <thead class="table-primary">
            <tr>
                <th>#</th>
                <th>Asset Tag</th>
                <th>Item Name</th>
                <th>Category</th>
                <th>Manufacturer</th>
                <th>Model</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Total</th>
                <th>Status</th>
                <th>Condition</th>
                <th>Assigned To</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% set ns = namespace(total=0) %}
            {% for stock in stocks %}
            {% set row_total = (stock.quantity or 0) * (stock.unit_price or 0) %}
            {% set ns.total = ns.total + row_total %}
            <tr class="{{ 'table-danger' if stock.is_low_stock else '' }}">
                <td>{{ loop.index }}</td>
                <td><small class="text-muted">{{ stock.asset_tag or '-' }}</small></td>
                <td>
                    {{ stock.item_name }}
                    {% if stock.is_low_stock %}<i class="bi bi-exclamation-triangle text-danger" title="Low Stock"></i>{% endif %}
                    {% if stock.is_warranty_expired %}<i class="bi bi-shield-exclamation text-warning" title="Warranty Expired"></i>{% endif %}
                </td>
                <td>{{ stock.category or '-' }}</td>
                <td><small>{{ stock.manufacturer or '-' }}</small></td>
                <td><small>{{ stock.model or '-' }}</small></td>
                <td>{{ stock.quantity }}</td>
                <td>{{ "%.2f" | format(stock.unit_price or 0) }}</td>
                <td>{{ "%.2f" | format(row_total) }}</td>
                <td>
                    {% if stock.status == 'Active' %}<span class="badge bg-success">Active</span>
                    {% elif stock.status == 'In Storage' %}<span class="badge bg-info">In Storage</span>
                    {% elif stock.status == 'Under Repair' %}<span class="badge bg-warning text-dark">Under Repair</span>
                    {% elif stock.status == 'Retired' %}<span class="badge bg-secondary">Retired</span>
                    {% elif stock.status == 'Lost-Stolen' %}<span class="badge bg-danger">Lost/Stolen</span>
                    {% elif stock.status == 'Disposed' %}<span class="badge bg-dark">Disposed</span>
                    {% else %}<span class="badge bg-secondary">{{ stock.status or '-' }}</span>{% endif %}
                </td>
                <td>
                    {% if stock.condition == 'Good' %}<span class="badge bg-success">{{ stock.condition }}</span>
                    {% elif stock.condition == 'Damaged' %}<span class="badge bg-danger">{{ stock.condition }}</span>
                    {% else %}<span class="badge bg-warning text-dark">{{ stock.condition }}</span>{% endif %}
                </td>
                <td>
                    {% if stock.assigned_user %}
                    <small><i class="bi bi-person-fill"></i> {{ stock.assigned_user.username }}</small>
                    {% else %}<small class="text-muted">-</small>{% endif %}
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="{{ url_for('stock.edit_stock', stock_id=stock.id) }}" class="btn btn-outline-warning" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <form method="POST" action="{{ url_for('stock.delete_stock', stock_id=stock.id) }}" style="display:inline"
                              onsubmit="return confirm('Delete this item?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="table-info fw-bold">
                <td colspan="8" class="text-end">Grand Total:</td>
                <td>{{ "%.2f" | format(ns.total) }}</td>
                <td colspan="4"></td>
            </tr>
        </tfoot>
    </table>
</div>
<p class="text-muted">Showing {{ stocks | length }} item(s)</p>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> No stock items found for this campus.
    <a href="{{ url_for('stock.add_stock') }}">Add stock</a> or
    <a href="{{ url_for('excel.upload_excel') }}">upload from Excel</a>.
</div>
{% endif %}
{% endblock %}
